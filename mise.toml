[settings]
experimental = true
verbose = false

[env]
DOTNET_CLI_TELEMETRY_OPTOUT = "1"
DOTNET_NOLOGO = "1"
DOTNET_SKIP_FIRST_TIME_EXPERIENCE = "1"
DOTNET_ReadyToRun = "1"
DOTNET_TC_QuickJitForLoops = "1"
ASPNETCORE_ENVIRONMENT = "Development"
DOTNET_WATCH_RESTART_ON_RUDE_EDIT = "1"
DOTNET_USE_POLLING_FILE_WATCHER = "0"  # Reduces file watcher overhead
MSBuildNodeReuseTimeout = "900"
DOTNET_CLI_UI_LANGUAGE = "en"  # Skip locale detection
MSBuildEnableWorkloadResolver = "false"  # Skip workload resolution if not needed
DOTNET_MaxDegreeOfParallelism = "24"
XUNIT_MAXPARALLEL = "24"
 
[tasks."prepare-solution"]
description = "Finds the solution file and exports it to SOLUTION_FILE env var"
hide = true
env = { SOLUTION_FILE = "$(mise run find-solution)" }

[tasks."dotnet:restore"]
depends = ["prepare-solution"]
description = "Restore NuGet packages with optimizations"
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet restore "${SOLUTION_FILE}" \
    --use-lock-file \
    --locked-mode \
    -maxcpucount:12 \
    --nologo
'''

[tasks."dotnet:build"]
depends = ["prepare-solution"]
description = "Builds the .NET solution. Warnings are NOT treated as errors."
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet build "${SOLUTION_FILE}" \
    /property:Configuration=Debug \
    /property:GenerateFullPaths=true \
    /consoleloggerparameters:NoSummary \
    /property:GenerateDocumentation=false \
    /property:IsLocalBuild=true \
    -maxcpucount:12 \
    -nodeReuse:true \
    /property:UseSharedCompilation=true \
    /property:BuildInParallel=true
'''

[tasks."dotnet:build:fast"]
depends = ["prepare-solution"]
description = "Builds the .NET solution quickly just for development."
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet build "${SOLUTION_FILE}" \
    /property:Configuration=Debug \
    /property:IsLocalBuild=true \
    --nologo \
    --no-restore \
    -maxcpucount:12 \
    -nodeReuse:true \
    /property:UseSharedCompilation=true \
    /property:BuildInParallel=true
'''

[tasks."dotnet:build:strict"]
depends = ["prepare-solution"]
description = "Builds the .NET solution from the scratch. Warnings are treated as errors."
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet build "${SOLUTION_FILE}" \
    /property:Configuration=Debug \
    /property:GenerateFullPaths=true \
    /consoleloggerparameters:NoSummary \
    /property:GenerateDocumentation=false \
    /property:IsLocalBuild=true \
    /property:TreatWarningsAsErrors=true \
    /warnaserror \
    --no-incremental
'''

[tasks."dotnet:coverage"]
depends = ["dotnet:build"]
description = "Runs tests and collects code coverage"
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

rm -rf **/CoverageResults/

EXCLUDE_PARAM=""
if [ -n "${COVERAGE_EXCLUDE:-}" ]; then
    EXCLUDE_PARAM="/property:Exclude=\"${COVERAGE_EXCLUDE}\""
fi

dotnet test --no-build "${SOLUTION_FILE}" \
    /property:GenerateFullPaths=true \
    /consoleloggerparameters:NoSummary \
    /property:CollectCoverage=true \
    /property:CoverletOutput=../CoverageResults/ \
    /property:MergeWith=../CoverageResults/coverage.json \
    /property:CoverletOutputFormat=\"lcov,json\" \
    --parallel \
    -- RunConfiguration.MaxCpuCount=12
'''

[tasks."dotnet:test"]
depends = ["dotnet:build:fast"]
description = "Runs the .NET unit tests (excludes integration tests)"
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet test --no-build "${SOLUTION_FILE}" \
    --filter "FullyQualifiedName!~Integration" \
    --parallel \
    --blame-hang-timeout 60s \
    -- RunConfiguration.MaxCpuCount=24 \
       RunConfiguration.DisableAppDomain=true \
       xUnit.MaxParallelThreads=24 \
       NUnit.NumberOfTestWorkers=24
'''

[tasks."dotnet:test:full"]
depends = ["dotnet:build"]
description = "Runs all .NET tests including integration tests"
quiet = true
dir = "{{ cwd }}"
run = '''
set -e

dotnet test --no-build "${SOLUTION_FILE}"
'''
