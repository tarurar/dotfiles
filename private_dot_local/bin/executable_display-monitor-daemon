#!/bin/bash
# Monitor for display changes on GNOME Wayland via D-Bus
# Runs as a daemon and triggers display-settings-switch when monitors change

LAST_STATE=""
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
LOG_FILE="$HOME/.local/share/display-switch.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [daemon] $1" >> "$LOG_FILE"
}

get_monitor_state() {
    gdbus call --session \
        --dest org.gnome.Mutter.DisplayConfig \
        --object-path /org/gnome/Mutter/DisplayConfig \
        --method org.gnome.Mutter.DisplayConfig.GetCurrentState 2>/dev/null \
        | grep -oE "'(eDP|DP|HDMI|USB-C|DVI|VGA)-[0-9]+'" | sort -u | tr '\n' ','
}

log "Display monitor daemon started"

# Get initial state
LAST_STATE=$(get_monitor_state)
log "Initial state: $LAST_STATE"

# Monitor D-Bus for MonitorsChanged signal
dbus-monitor --session "type='signal',interface='org.gnome.Mutter.DisplayConfig',member='MonitorsChanged'" 2>/dev/null | \
while read -r line; do
    if echo "$line" | grep -q "MonitorsChanged"; then
        log "MonitorsChanged signal received"
        sleep 2  # Wait for display to stabilize

        NEW_STATE=$(get_monitor_state)
        if [ "$NEW_STATE" != "$LAST_STATE" ]; then
            log "State changed: $LAST_STATE -> $NEW_STATE"
            LAST_STATE="$NEW_STATE"
            "$SCRIPT_DIR/display-settings-switch"
        else
            log "Signal received but state unchanged"
        fi
    fi
done
